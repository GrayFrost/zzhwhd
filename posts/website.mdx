---
title: 个人网站的搭建记录
date: '2025-03-10'
tags: ['react', 'nextjs', 'nginx', 'docker', 'git']
category: "建站"
---

首先是分享自己网站的整体变迁流程

最开始是使用hexo + github pages 

隔了几年，使用cra来搭建react项目，然后改成使用vite，打包后手动上传，再用nginx来起服务。

推荐一个xshell工具，termius。

后来尝试了一下宝塔

域名的申请、https、阿里云服务上申请免费的证书、nginx配置https证书 备案

之前我使用了一个github上的nextjs博客模板，搭配vercel来跑我的个人博客。

这次我想除了博客外，还应该包括一些而外的东西，比如自己灵光乍现的项目，生活等等。

还是沿用了next，同时我希望在国内的网络环境下也能正常访问，所以我打算使用国内的服务器备案后，自己跑nextjs项目

一开始没做好了解，以为nextjs项目和普通的react项目没有区别，打包后，拖个dist目录到服务器上就完事了。

然而发现不是。

这种服务端渲染的项目和之前的静态页面展示有很大的不同。

我需要在我的服务器上直接把整个项目文件上传上去，然后运行这个项目。相当于在服务器上不打包，直接跑项目。

如果配置了安全组，我能通过ip加服务的端口号3000来直接访问这个项目。

同时为了这个项目能够持续运行，还需要使用pm2来守护这个运行的进程。

之后是nginx的配置，需要修改成代理到localhost:3000里去

在域名备案还未成功时，遇到一些https直接访问无法访问的问题，当时还联系了阿里云的客服，让他们帮我解答疑惑。

之后能顺利访问了。

接下来便是解决最大的问题，每次更新代码后，需要在服务器上git pull最新代码，然后把服务停了重新跑这一系列人工操作问题。

我自然而然想到的是github actions，不过之前我可能会想到jenkins来部署，但是jenkins我个人感觉还是有点繁琐。

所以我选用了github actions + docker来部署我的nextjs项目。

在服务器上安装docker。
docker的一些命令。
比如build打包镜像，run运行容器等。

docker compose 管理nextjs容器和nginx容器。

首先需要在项目下建dockerfile和nginx.conf。
dockerfile的作用是用于打包一个nextjs项目镜像，然后把nextjs 在npm run build之后的一些文件映射到容器里去。

docker-compose里则是把我们nextjs项目里配置的nginx.conf映射到nginx容器的配置里去，同时把服务器上的https证书也映射进去。

github actions的流程

阿里云docker镜像仓库 命名空间、项目名称

在代码提交到main分支时触发action

在github上配置secrets

首先是登录我的阿里云docker镜像仓库，把我github上最新代码docker build后推送到这个镜像仓库上。

然后我登录阿里云ecs服务器，拉取最新的镜像，同时删除旧的容器，准备跑我新的容器。

这里我遇到一个问题，就是明明我已经构建了最新的镜像，我看镜像上的tag也是我最新的提交。但是我访问页面时，看到的还是旧的内容。

起初我以为是nginx缓存的问题，给nginx.conf的访问上全都设置了不缓存，结果发现一点用的没有。

知道我在宝塔上，访问文件路径，点开我更改的文件内容时，发现仍旧是旧内容。此时我才发现端倪。

原来之前我的dockerfile一直配置有问题，每次打包都会基于dockerfile所在目录的文件进行重新构建。

即使我拉取了镜像仓库的最新镜像，然而我使用的nextjs镜像还是基于服务器上的旧代码重新构建的镜像。

所以我调整了dockerfile的配置以及deploy.yml的配置，同时把原来nginx的无缓存配置给还原了。

现在在登录到阿里云服务器是，我的deploy流程还有一步，是会去git pull拉取一遍代码，确保是最新的，因为比如我的docker compose运行是基于这个远程目录下的docker-compose.yml，所以我要确保它也是最新的，
免得我有时更新了这些配置，在运行的时候却还是用老配置。


